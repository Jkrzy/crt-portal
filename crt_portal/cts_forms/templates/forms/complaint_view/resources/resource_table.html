{% load sortable_table_heading %}

<form class="usa-form"
      method="get"
      action=""
      novalidate
>
  <div class="crt-xscroll">
    <table class="usa-table crt-table sort-table">
    {# This "fake" table makes nested headers available to screen readers #}
    <span tabindex="-1" role="table" class="usa-sr-only">
        <span role="row">
        <span role="columnheader" class="usa-sr-only" id="crt-table-indiv-contacts-header">Individual Contacts</span>
        <span role="columnheader" class="usa-sr-only" id="crt-table-notes-header">Notes</span>
        </span>
    </span>
      <thead>
        <tr>
          <th aria-label="Bulk Action Selection">
            <div class="usa-checkbox td-checkbox">
              <input type="checkbox"
                     name="all"
                     class="usa-checkbox__input checkbox-input-all"
                     value="all"
              >
              <label class="usa-checkbox__label crt-checkbox__label checkbox-all" aria-label="Select all records"></label>
            </div>
          </th>
          <th aria-label="Detail toggles">
            <a aria-expanded="false" role="button" aria-label="Expand all detail rows" class="td-toggle-all display-flex" data-posted='false' href="#">
              <img alt="" aria-hidden="true" src="{% static "img/intake-icons/ic_chevron-right.svg" %}" class="icon">
            </a>
          </th>
          {% render_sortable_heading 'Section' sort_state %}
          {% render_sortable_heading 'Organization' sort_state %}
          {% render_sortable_heading 'Phone' sort_state %}
          {% render_sortable_heading 'Url' sort_state %}
          {% render_sortable_heading 'Other Resources Available' sort_state %}
          {% render_sortable_heading 'Tags' sort_state %}
       </tr>
      </thead>
      {% if resources %}
        <tbody>
          {% for resource in resources %}
            <tr class="tr-status-{{ resource.resource.section }} tr--hover{% cycle ' stripe' '' %}">
              <td>
                <div class="usa-checkbox td-checkbox">
                  <input type="checkbox"
                         name="id"
                         class="usa-checkbox__input"
                         value="{{ resource.resource.id }}"
                         id="checkbox-{{ resource.resource.id }}"
                  >
                  <label class="usa-checkbox__label crt-checkbox__label" for="checkbox-{{ resource.resource.id }}" aria-label="Select record {{ resource.resource.id }}"></label>
                </div>
              </td>
              <td>
                <a data-id="{{ resource.resource.id }}" aria-expanded="false" aria-label="Expand details for Record {{resource.resource.id}}" role="button" aria-controls="tr-additional-{{ resource.resource.id }}" class="td-toggle display-flex" href="#">
                  <img aria-hidden="true" src="{% static "img/intake-icons/ic_chevron-right.svg" %}" class="icon">
                </a>
              </td>
              <td>
                <a class="td-link display-block" href="{{resource.url}}">
                  <span class="status-tag status-closed">
                    {{ resource.resource.section }}
                  </span>
                </a>
              </td>
              <td><a class="td-link display-block text-uppercase" href="{{resource.url}}">{{ resource.resource.name }}</a></td>
              <td><a class="td-link display-block" href="{{resource.url}}">{{ resource.resource.phone }}</a></td>
              <td>{% if datum.resource.url %}<a href="{{datum.resource.url}}" class="text-uppercase">{{ datum.resource.url }}</a>{% endif %}</td>
              <td><a class="td-link display-block" href="{{resource.url}}"></a></td>
              <td>
                <a class="td-link display-block" href="{{datum.url}}">
                    {% for tag in resource.tags %}
                    <span class="usa-tooltip" data-position="right" data-classes="display-inline" title="{{ tag.tooltip }}">
                        <span class='usa-tag usa-tag--big'>
                            <span class='name'>{{ tag.name }}</span>
                        </span>
                    </span>
                    {% endfor %}
                </a>
              </td>
            </tr>
            {# this row is hidden by default #}
            <tr class="tr-quickview" id="tr-additional-{{ resource.resource.id }}" hidden>
              <td class="quickview">
                <span class="usa-sr-only">Details for record {{ resource.resource.id }}</span>
              </td>
              {# All screen readers don't yet read the headers attribute correctly, so we've added a redundant aria-label #}
              {# https://a11ysupport.io/tech/html/headers_attribute #}
              <td aria-label="Individual Contacts" headers="crt-table-indiv-contacts-header" class="quickview" colspan="5">
                <label aria-hidden="true" for="tr-quickview-indiv-contacts-{{ resource.resource.id }}" class="td-quickview">
                  Individual Contacts
                </label>
                <div tabindex="0" role="textbox" aria-readonly="true" id="tr-quickview-indiv-contacts-{{ resource.resource.id }}" class="td-indiv-contacts">
                    <a class="td-link display-block" href="{{resource.url}}">
                     <p> {% for contact in resource.contacts %}
                        {% with last=contact.last_name|default:"—" %}
                        {{ last|truncatechars:20 }}{% endwith %}, {% with first=contact.first_name|default:"—" %}
                        {{ first|truncatechars:20 }}
                        {% endwith %} <br />
                          {{ contact.title }} <br />
                        {{ contact.email }} <br />
                       {{ contact.phone }}</p>
                      {% endfor %}
                    </a>
                </div>
              </td>
              <td aria-label="Notes" headers="crt-table-notes-header" class="quickview" colspan="6">
                <label aria-hidden="true" for="tr-quickview-notes-{{ resource.resource.id }}" class="td-quickview">
                  Notes
                </label>
                <div tabindex="0" role="textbox" aria-readonly="true" id="tr-quickview-notes-{{ resource.resource.id }}" class="td-notes word-break">
                  {{ resource.resource.notes|linebreaks|default:"-" }}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      {% endif %}
    </table>
  </div>
</form>

{% if not resources %}
  <div class="crt-portal-card table-message">
    <div class="crt-portal-card__content">
      <div class="grid-container padding-bottom-2">
        <div class="align-center">
          <img alt="filter icon" src="{% static 'img/filters.svg' %}" class="margin-top-1" />
          <p class="margin-bottom-1 margin-top-1" role="status"><b>No resources found</b></p>
          <em>Try adjusting your filters to see more resources</em>
        </div>
      </div>
    </div>
  </div>
{% endif %}

{% if not page_format.has_next and resources %}
  <div class="crt-portal-card table-message">
    <div class="crt-portal-card__content">
      <div class="grid-container padding-bottom-2">
        <div class="align-center">
          <p class="margin-bottom-1">
            <img alt="encouraging coffee icon" src="{% static 'img/coffee.svg' %}" />
            <b>End of results</b>
          </p>
          <em>Try adjusting your filters to see more resources</em>
        </div>
      </div>
    </div>
  </div>
{% endif %}
